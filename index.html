<!DOCTYPE html>
<html>
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112417989-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-112417989-2');
    </script>
    <title>COVID-19 Illinois</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="data.js"></script>
    <style>
      body {
        margin: 20px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        background-color: #222;
        color: #CCC;
      }
      a, a:visited, a:active {
        color: #3DF;
      }
      .chart-container {
        height: calc(100vh - 200px);
        width: calc(100vw - 40px);
        max-height: calc(100vw - 40px);
      }
      .button {
        border: 1px solid #444;
        color: #444;
        border-radius: 10px;
        user-select: none;
        display: inline-block;
        margin-right: 10px;
        margin-top: 10px;
        padding: 10px 20px;
        cursor: pointer;
      }
      .button.active {
        border-color: #3DF;
        color: #3DF;
      }
    </style>
  </head>
  <body>
    <h1>COVID-19 Illinois</h1>
    <p>
      <small>Data source: <a target="_blank" rel="noreferrer noopener" href="http://www.dph.illinois.gov/topics-services/diseases-and-conditions/diseases-a-z-list/coronavirus">Illinois Department of Public Health</a></small><br/>
      <small id="last-updated"></small>
    </p>
    <div class="chart-container">
        <canvas id="chart"></canvas>
    </div>
    <p id="legend-primary"></p>
    <p id="legend-secondary"></p>

    <script>
      document.getElementById('last-updated').innerHTML = 'Last updated on: ' + data.updated;

      var axes = [{
        gridLines: { color: '#444' },
        ticks: { fontColor: '#CCC' },
      }];

      var myChart = new Chart(document.getElementById('chart').getContext('2d'), {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: Object.keys(data.sets).map(function(area) {
            return {
              hidden: true,
              label: area,
              lineTension: 0,
              pointRadius: 5,
              pointHoverRadius: 5,
              pointHitRadius: 30,
              fill: false,
              spanGaps: true,
              borderColor: data.sets[area].color,
              backgroundColor: data.sets[area].color,
              data: data.sets[area].positive,
            };
          }),
        },
        plugins: [ChartDataLabels],
        options: {
          maintainAspectRatio: false,
          animation: false,
          legend: {
            display: false,
            position: 'bottom',
            labels: {
                boxWidth: 12,
                padding: 16,
                fontColor: '#CCC',
            },
          },
          scales: {
            xAxes: axes,
            yAxes: axes,
          },
          plugins: {
            datalabels: {
              anchor: 'end',
              align: 'left',
              offset: 8,
              borderRadius: 5,
              textStrokeWidth: 4,
              textStrokeColor: '#222',
              color: function(context) {
                return context.dataset.backgroundColor;
              },
              formatter: function(value, context){
                return context.dataset.data.length === context.dataIndex + 1 ? context.dataset.label : null;
              }
            }
          }
        },
      });

      var areas = {};

      Object.keys(data.sets).forEach(function(area) {
        areas[area] = false;
      });

      function toggleArea(area) {
        areas[area] = !areas[area];
        updateChart();
      }

      function updateChart() {
        myChart.data.datasets.forEach(function(ds) {
          ds.hidden = !areas[ds.label];
        });
        myChart.update();
        updateLagend();
      }

      function updateLagend() {
        var primaryAreas = ['Illinois', 'Chicago', 'Tested'];

        document.getElementById('legend-primary').innerHTML = primaryAreas.map(renderAreaButton).join('');
        document.getElementById('legend-secondary').innerHTML = Object.keys(areas).sort().map(function(area) {
          return primaryAreas.includes(area) ? '' : renderAreaButton(area);
        }).join('');
      }

      function renderAreaButton(area) {
        return ['<a class="button ', areas[area] ? 'active' : '', '" onclick="toggleArea(\'', area, '\')">', area, '</a>'].join('');
      }

      areas['Illinois'] = true;
      areas['Chicago'] = true;

      updateChart();
    </script>
  </body>
</html>
